<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>Don't Forget The Elephant</title>

        <meta name="description" content="A Review of Modern PostgreSQL">
        <meta name="author" content="Keith Fiske">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="css/reveal.min.css">
        <link rel="stylesheet" href="css/theme/omniti.css" id="theme">

        <!-- For syntax highlighting -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <!-- If the query includes 'print-pdf', include the PDF print sheet -->
        <script>
            if( window.location.search.match( /print-pdf/gi ) ) {
                var link = document.createElement( 'link' );
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = 'css/print/pdf.css';
                document.getElementsByTagName( 'head' )[0].appendChild( link );
            }
        </script>

        <style>
            #li30 li { line-height:30px }
        </style>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="reveal">

            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">
                <section data-background="css/theme/omniti_bg_logo.png">
                    <h2>Don't Forget The Elephant</h2>
                    <h4>A Review of Modern PostgreSQL</h4>
                    <p>
                        <small>Presented by <a href="http://keithf4.com" target="_blank">Keith Fiske</a> / <a href="http://twitter.com/keithf4" target="_blank">@keithf4</a></small>
                    </p>
                    <p>
                    <small>Database Administrator @ <a href="http://www.omniti.com" target="_blank">OmniTI</a></small>
                    </p>
                    <p>
                    <br/>
                    <br/>
                    <small>Follow along at <br/><a href="http://slides.keithf4.com/dontforget">http://slides.keithf4.com/dontforget</a></small>
                    </p>
                </section>

                <section data-background="css/theme/omniti_bg_logo.png">
                    <h2>OmniTI, Inc</h2>
                    <p>
                        <ul>
                            <li>Full-stack support for high-traffic websites & applications</li>
                            <ul>
                                <li>Millions of users</li>
                                <li>Terabytes of data</li>
                                <li>Gilt, Etsy, Ora.TV, Freelotto</li>
                            </ul>
                            <li>Surge Conference</li>
                            <ul>
                                <li> <a href="http://omniti.com/surge">http://surge.omniti.com</a></li>
                                <li>Annually in Sept</li>
                            </ul>
                            <li>We're hiring!</li>
                            <ul>
                                <li><a href="http://omniti.com/is/hiring">http://omniti.com/is/hiring</a></li>
                                <li>SysAdmins, DBAs, Developers, Kernel Hackers
                        </ul>
                    </p>

                </section>

                <section data-background="css/theme/omniti_bg_logo.png">
                    <h2>What is PostgreSQL?</h2>
                    <p>
                    <ul>
                        <li>Open Source RDBMS</a>
                        <li>Started at UC Berkley 1986, open sourced in 1996</li>
                        <li>BSD-type License</li>
                        <li>Follows SQL Standard very closely</li>
                        <li>Yearly major version releases (x.x)</li>
                        <ul>
                            <li>Minor (x.x.x) patch releases as needed</li>
                            <li>Generally patch all supported versions at one time</li>
                        </ul>
                        <li>Third-party Plugin Support</li>
                        <ul>
                            <li>Procedural Languages</li>
                            <ul>
                                <li>C, Java, Python, Perl, JavaScript, PHP, R, Ruby, etc</li>
                            </ul>
                            <li>Extensions</li>
                            <li>Background Workers</li>
                        </ul>
                        <li><a href="http://www.postgresql.org/list/" target="_blank">Mailing Lists</a>, <a href="http://www.postgresql.org/community/irc/" target="_blank">IRC</a>, <a href="http://wiki.postgresql.org" target="_blank">Wiki</a>, <a href="http://planet.postgresql.org" target="_blank">planet.postgresql.org</a>, <a href="https://wiki.postgresql.org/wiki/Events" target="_blank">Conferences & User Groups</a></li>
                    </ul>
                </section>

                <section data-background="css/theme/omniti_bg_logo.png">
                    <section>
                        <h2>A Brief History of Releases</h2>
                    </section>
                    <section>
                        <table width="100%">
                            <tr>
                                <th>Version</th>
                                <th>Released</th>
                                <th>Final Version</th>
                                <th>EOL</th>
                            </tr>
                            <tr>
                                <td>PostgreSQL 8.3</td>
                                <td>Feb 2008</td>
                                <td>8.3.23</td>
                                <td>Feb 2013</td>
                            </tr>
                            <tr>
                                <td>PostgreSQL 8.2</td>
                                <td>Dec 2006</td>
                                <td>8.2.23</td>
                                <td>Dec 2011</td>
                            </tr>
                            <tr>
                                <td>PostgreSQL 8.1</td>
                                <td>Nov 2005</td>
                                <td>8.1.23</td>
                                <td>Oct 2010</td>
                            </tr>
                            <tr>
                                <td>PostgreSQL 8.0</td>
                                <td>Jan 2005</td>
                                <td>8.0.26</td>
                                <td>Oct 2010</td>
                            </tr>
                            <tr>
                                <td>PostgreSQL 7.4</td>
                                <td>Nov 2003</td>
                                <td>7.4.30</td>
                                <td>Oct 2010</td>
                            </tr>
                            <tr>
                                <td>PostgreSQL 7.3</td>
                                <td>Nov 2002</td>
                                <td>7.3.21</td>
                                <td>Nov 2007</td>
                            </tr>
                            <tr>
                                <td>PostgreSQL 7.2</td>
                                <td>Feb 2002</td>
                                <td>7.2.8</td>
                                <td>Feb 2007</td>
                            </tr>
                            <tr>
                                <td>PostgreSQL 7.1</td>
                                <td>Apr 2001</td>
                                <td>7.1.3</td>
                                <td>Apr 2006</td>
                            </tr>
                            <tr>
                                <td>PostgreSQL 7.0</td>
                                <td>May 2000</td>
                                <td>7.0.3</td>
                                <td>May 2005</td>
                            </tr>
                           <tr>
                                <td>PostgreSQL 6.5</td>
                                <td>June 1999</td>
                                <td>6.5.3</td>
                                <td>June 2004</td>
                            </tr>
                           <tr>
                                <td>PostgreSQL 6.4</td>
                                <td>Oct 1998</td>
                                <td>6.4.2</td>
                                <td>Oct 2003</td>
                            </tr>
                            <tr>
                                <td>PostgreSQL 6.3</td>
                                <td>March 1998</td>
                                <td>6.3.2</td>
                                <td>March 2003</td>
                            </tr>
                        </table>
                    </section>
                </section>

<!--                <section data-background="css/theme/omniti_bg_logo.png">
                    <section>
                        <h1>8.0 Features</h1>
                        (Released Jan 2005 - EOL Oct 2010)
                    </section>
                    <section>
                        <ul>
                            <li>Native Microsoft Windows release</li>
                            <li>Savepoints</li>
                            <li>Point-In-Time Recovery (PITR)</li>
                            <li>Tablespaces</li>
                            <li>Change column types</li>
                        </ul>
                       <aside class="notes">
                           <ul>
                               <small>
                               <li>Savepoints allow specific parts of a transaction to be aborted without affecting the remainder of the transaction. Prior releases had no such capability; there was no way to recover from a statement failure within a transaction except by aborting the whole transaction. This feature is valuable for application writers who require error recovery within a complex transaction.</li>
                               </small>
                           </ul>
                       </aside>
                    </section>
                </section> 

                <section data-background="css/theme/omniti_bg_logo.png">
                    <section>
                        <h1>8.1 Features</h1>
                        (Released Nov 2005 - EOL Nov 2010)
                    </section>
                    <section>
                        <ul>
                            <li>Two-phase commit</li>
                            <li>Role system simplified separate user/group</li>
                            <li>Greatly improved memory management for increased concurrency performance</li>
                            <li>Auto-vacuum moved into main server (was contrib module)</li>
                        </ul>
                        <aside class="notes">
                            <ul>
                                <small>
                                <li>Two-phase commit allows transactions to be "prepared" on several computers, and once all computers have successfully prepared their transactions (none failed), all transactions can be committed. Even if a machine crashes after a prepare, the prepared transaction can be committed after the machine is restarted. New syntax includes PREPARE TRANSACTION and COMMIT/ROLLBACK PREPARED. A new system view pg_prepared_xacts has also been added.</li>
                                <li>Access to the shared buffer cache was identified as a significant scalability problem, particularly on multi-CPU systems. In this release, the way that locking is done in the buffer manager has been overhauled to reduce lock contention and improve scalability. The buffer manager has also been changed to use a "clock sweep" replacement policy.</li>
                            </small>
                            </ul>
                        </aside>
                    </section>
                </section> 

                <section data-background="css/theme/omniti_bg_logo.png">
                    <section>
                        <h1>8.2 Features</h1>
                        (Released Dec 2006 - EOL Dec 2011)
                    </section>
                    <section>
                        <ul>
                            <li>Concentrated on user requested features for easier administration and better performance</li>
                            <ul>
                                <li>INSERT/UPDATE/DELETE ... RETURNING ...</li>
                                <li>Concurrent index creation</li>
                                <li>Many query planner improvements</li>
                                <li>More efficient locking for better concurrency</li>
                                <li>More efficient vacuuming</li>
                            </ul>
                    </section>
                </section> 

                <section data-background="css/theme/omniti_bg_logo.png">
                    <section>
                        <h1>8.3 Features</h1>
                        (Released Feb 2008 - EOL Feb 2013)
                    </section>
                    <section>
                        <ul>
                            <li>Full text search integrated into core system</li>
                            <li>ENUM & UUID types</li>
                            <li>Concurrent autovacuum allowed spawning of multiple vacuum jobs automatically</li>
                            <li>Updatable cursors</li>
                        </ul>
                    </section>
                </section> 
-->
                <section data-background="css/theme/omniti_bg_logo.png">
                    <section>
                        <h1>8.4 Features</h1>
                        Released July 2009 - EOL July 2014<br />
                        Final Version 8.4.22
                    </section>
                    <section>
                        <h2>Window Functions</h2>
                        <ul>
                            <li>Performs a calculation across a set of table rows that are somehow related to the current row</li>
                            <li>The OVER clause determines exactly how the rows of the query are split up for processing by the window function</li>
                        </ul>
                        <pre><code data-trim>
SELECT salary, sum(salary) OVER () FROM empsalary;

 salary |  sum  
--------+-------
   5200 | 47100
   5000 | 47100
   3500 | 47100
   4800 | 47100
   3900 | 47100
   4200 | 47100
   4500 | 47100
   4800 | 47100
   6000 | 47100
   5200 | 47100
(10 rows)


SELECT salary, sum(salary) OVER (ORDER BY salary) FROM empsalary;

 salary |  sum  
--------+-------
   3500 |  3500
   3900 |  7400
   4200 | 11600
   4500 | 16100
   4800 | 25700
   4800 | 25700
   5000 | 30700
   5200 | 41100
   5200 | 41100
   6000 | 47100
(10 rows)
                        </code></pre>
                        <aside class="notes">
                        <small>
                            <ul>
                                <li>For each row, there is a set of rows within its partition called its window frame</li>
                                <li>Many (but not all) window functions act only on the rows of the window frame, rather than of the whole partition. By default, if ORDER BY is supplied then the frame consists of all rows from the start of the partition up through the current row, plus any following rows that are equal to the current row according to the ORDER BY clause.
                            </ul>
                        </small>
                        </aside>
                    </section>
                    <section>
                        <h2>Window Functions</h2>
                        <ul>
                            <li>The PARTITION BY list within OVER specifies dividing the rows into groups, or partitions, that share the same values of the PARTITION BY expression(s).</li>
                        </ul>
                        <pre><code data-trim>
SELECT depname, empno, salary, avg(salary) 
OVER (PARTITION BY depname) 
FROM empsalary;

  depname  | empno | salary |          avg          
-----------+-------+--------+-----------------------
 develop   |    11 |   5200 | 5020.0000000000000000
 develop   |     7 |   4200 | 5020.0000000000000000
 develop   |     9 |   4500 | 5020.0000000000000000
 develop   |     8 |   6000 | 5020.0000000000000000
 develop   |    10 |   5200 | 5020.0000000000000000
 personnel |     5 |   3500 | 3700.0000000000000000
 personnel |     2 |   3900 | 3700.0000000000000000
 sales     |     3 |   4800 | 4866.6666666666666667
 sales     |     1 |   5000 | 4866.6666666666666667
 sales     |     4 |   4800 | 4866.6666666666666667
(10 rows)


SELECT depname, empno, salary, rank() 
OVER (PARTITION BY depname ORDER BY salary DESC) 
FROM empsalary;

  depname  | empno | salary | rank 
-----------+-------+--------+------
 develop   |     8 |   6000 |    1
 develop   |    10 |   5200 |    2
 develop   |    11 |   5200 |    2
 develop   |     9 |   4500 |    4
 develop   |     7 |   4200 |    5
 personnel |     2 |   3900 |    1
 personnel |     5 |   3500 |    2
 sales     |     1 |   5000 |    1
 sales     |     4 |   4800 |    2
 sales     |     3 |   4800 |    2
(10 rows)

                        </code></pre>
                        <aside class="notes">
                        <small>
                            <ul>
                                <li> Normally the avg() would be for all rows in the output. The first three output columns come directly from the table empsalary, and there is one output row for each row in the table. The fourth column represents an average taken across all the table rows that have the same depname value as the current row.</li>
                                <li> The rank function produces a numerical rank within the current row's partition for each distinct ORDER BY value, in the order defined by the ORDER BY clause. rank needs no explicit parameter, because its behavior is entirely determined by the OVER clause.</li>
                            </ul>
                        </small>
                        </aside>
                    </section>
                    <section>
                        <h2>Common Table Expression</h2>
                        <div id="li30">
                            <ul style="font-size:25px">
                                <li>WITH provides a way to write auxiliary statements for use in a larger query</li>
                                <li>These statements, referred to as Common Table Expressions or CTEs, can be thought of as defining temporary tables that exist just for one query</li>
                                <li>WITH queries are useful because they are evaluated only once per execution of the parent query, even if they are referred to more than once by the parent query or sibling WITH queries.</li>
                            </ul>
                        <pre><code data-trim>
WITH regional_sales AS (
        SELECT region, SUM(amount) AS total_sales
        FROM orders
        GROUP BY region
     ), top_regions AS (
        SELECT region
        FROM regional_sales
        WHERE total_sales > (SELECT SUM(total_sales)/10 FROM regional_sales)
     )
SELECT region,
       product,
       SUM(quantity) AS product_units,
       SUM(amount) AS product_sales
FROM orders
WHERE region IN (SELECT region FROM top_regions)
GROUP BY region, product;
                        </code></pre>
                        </div>
                        <aside class="notes">
                            <small>
                                <ul>
                                    <li>Each auxiliary statement in a WITH clause can be its own SELECT statement</li>
                                    <li>The WITH clause itself is attached to a primary statement that can also be a SELECT</li>
                                </ul>
                            </small>
                        </aside>
                    </section>
                    <section>
                        <h2>Common Table Expressions</h2>
                            Allow recursive queries
                        <pre><code data-trim>
WITH RECURSIVE t(n) AS (
    VALUES (1)
  UNION ALL
    SELECT n+1 FROM t WHERE n < 100
)
SELECT sum(n) FROM t;

 sum  
------
 5050
(1 row)

                        </code></pre>
                        <aside class="notes">
                            Like a normal recursive function, there is an initial condition (VALUES(1)) followed by step to perform that refers back to itself. In this case the WHERE condition provides the exit from recursion.
                        </aside>
                    </section>
                    <section>
                        <h2>Parallel pg_restore</h2>
                        <ul>
                            <li>Prior versions, each object was restored serially one after the other</li>
                            <li>Parallel option tells it to always keep restoring that many objects at all times until complete.</li>
                            <li>Significantly reduced downtime for major version upgrades</li>
                        </ul>
                        <aside class="notes">
                            <small>
                            Not just telling it parallel batch sizes. Like multiple assembly lines all running at once. If parallel is set to 10, there are always that many objects being restored. This allows it to keep working on larger tables in the background while smaller tables and all other objects continue to keep restoring and finish.
                            </small>
                        </aside>
                    </section>
                    <section>
                        <h2>Additional 8.4 Features</h2>
                        <ul>
                            <li>Default & variadic parameters for functions</li>
                            <li>Column permissions</li>
                            <li>Per-database locale settings</li>
                            <li>SSL certificate authentication</li>
                            <li>Automatic sizing of Free Space Map (eliminated significant administrative headache)</li>
                            <li>Live editing of functions (\ef in psql)</li>
                            <li>New contrib modules: pg_stat_statements, auto_explain, btree_gin</li>
                        </ul>
                    </section>
                </section> 
                <!-- end of 8.4 -->

                <section data-background="css/theme/omniti_bg_logo.png">
                    <section>
                        <h1>9.0 Features</h1>
                        Released Sept 2010 - EOL Sept 2015<br />
                        Final Version 9.0.23
                    </section>
                    <section>
                        <h2>Streaming Replication</h2>
                        <ul>
                            <li>Prior replication methods required significant setup and relied on third-party tools (commands given to archive_command)</li>
                            <li>Simple, TCP-based connection method</li>
                            <li>Significantly reduced lag time between master & slave systems (less than 1 second)</li>
                        </ul>
                    </section>
                    <section>
                        <h2>Hot Standby</h2>
                        <ul>
                            <li>Allow readonly connections to slave servers</li>
                            <li>Offset load on master systems by sending non-write queries to slave(s)</li>
                            <li>Better security: allow access to data but not to a system that permits writes</li>
                    </section>
                    <section>
                        <h2>pg_upgrade</h2>
                        <ul>
                            <li>Previously, all major version (x.x) upgrades required a full dump & restore</li>
                            <li>Can either copy existing files to new data directory or can use hard links to reuse old files</li>
                            <li>Link method can allow very quick upgrade of large databases (ex: 1.2TB in &lt; 2min; does not include stats update) </li>
                            <li>Minimum version to use: 8.4.7</li>
                            <ul>
                                <li>Anything older still requires dump & restore</li>
                            </ul>
                    </section>
                    <section>
                        <h2>Additional 9.0 Features</h2>
                        <ul>
                            <li>Enhanced permissions management</li>
                            <ul>
                                <li>Grant to all objects in schema with single command</li>
                                <li>Alter initial, default privileges of objects created by specific roles</li>
                            </ul>
                            <li>Better VACUUM FULL</li>
                            <li>Windows 64-bit support</li>
                            <li>Anonymous code blocks (DO statement)</li>
                            <li>Deferrable unique constraints</li>
                            <li>Enhanced EXPLAIN plans. Export in JSON, XML or YAML</li>
                        </ul>

                       <aside class="notes">
                           <ul>
                               <li>VACUUM FULL now rewrites entire table and indexes rather than moving rows. Avoids index bloat that used to be caused pre-9.0</li>
                               <li>Deferred unique constraint means allowing a constraint to be checked at the end of a multi-row update instead of checking as each row is inserted</li>
                           </ul>
                        </aside>

                    </section>
                </section>
                <!-- end of 9.0 -->

                <section data-background="css/theme/omniti_bg_logo.png">
                    <h2>Friendly Reminder</h2>
                    <ul>
                        <li>If you are running any version &lt;= 9.0, you are no longer receiving support</li>
                        <li>9.0 support ended Sept 2015</li>
                        <li>No security updates & no data corruption fixes!</li>
                        <li>Significant performance increases from 8.4 and up</li>
                        <li>Getting to new version now will make future upgrades much easier (pg_upgrade)</li>
                        <li>We can help! - <a href="http://www.omniti.com" target="_blank">omniti.com</a></li>
                    </ul>
                </section>
                <!-- end of friendly reminder -->

                <section data-background="css/theme/omniti_bg_logo.png">
                    <section>
                        <h1>9.1 Features</h1>
                        Released Sept 2011 - EOL Sept 2016<br />
                        Current verison 9.1.19
                    </section>
                    <section>
                        <h2>Foreign Data Wrappers</h2>
                        <ul>
                            <li>SQL/MED (Management of External Data) part of SQL Standard</li>
                            <li>Connect to remote databases/filesystems/services as if they were local tables inside PostgreSQL</li>
                            <li>Oracle, MySQL, SQL Server, SQLite, MongoDB, Redis, CSV Files, Twitter, etc</li>
                            <li>Joins & conditions pushed to remote system</li>
                            <li>Still performance issues joining local tables w/ remote</li>
                            <li>Ease the migration to PostgreSQL from different databases</li>
                        </ul>
                    </section>
                    <section>
                        <h2>Extensions</h2>
                        <ul>
                            <li>Package related objects into a managed bundle</li>
                            <li>Versioned</li>
                            <ul>
                                <li>Ensure all systems have the same code</li>
                                <li>Controlled upgrades & downgrades</li>
                            </ul>
                            <li>All contrib modules are now extensions</li>
                            <li>Examples: <a href="http://postgis.net/" target="_blank">PostGIS</a>, <a href="http://reorg.github.io/pg_repack/" target="_blank">pg_repack</a>, <a href="https://github.com/keithf4/pg_partman" target="_blank">pg_partman</a></li> 
                        </ul>
                    </section>
                    <section>
                        <h2>Writable CTE</h2>
                        <ul>
                            <li>WITH statements can now contain INSERT, UPDATE & DELETE</li>
                            <li>Use RETURNING clause to do fun things</li>
                        </ul>
                        <pre><code data-trim>
WITH moved_rows AS (
    DELETE FROM products
    WHERE
        "date" >= '2010-10-01' AND
        "date" < '2010-11-01'
    RETURNING *
)
INSERT INTO products_log
SELECT * FROM moved_rows;
                        </code></pre>
                        <aside class="notes">
                            Rows deleted in WITH statement are returned by RETURNING to be used by the SELECT statement to populate another table that tracks deletes
                        </aside>
                    </section>
                    <section>
                        <h2>Writable CTE</h2>
                        <ul>
                            <li>Simplify transactional logic that contains multiple, related insert/update/delete statements</li>
                            <li>As a side-effect, significantly improves performance!</li>
                            <pre><code data-trim>
BEFORE:
BEGIN;
INSERT INTO users (name, email) VALUES (?,?) RETURNING userid;

INSERT INTO addresses (userid, address, city, state, zip) 
VALUES (?,?,?,?,?) RETURNING addressid;

INSERT INTO user_history (userid, addressid, action) VALUES (?,?,?) RETURNING historyid;
COMMIT;

AFTER:
WITH userdata AS (
  INSERT INTO users (name, email) VALUES (?,?)
  RETURNING userid
), addressdata AS (
  INSERT INTO addresses (userid, address, city, state, zip)
  SELECT userid,?,?,?,?
  FROM userdata
  RETURNING addressid 
), historydata AS (
  INSERT INTO user_history (userid, addressid, action)
  SELECT userid, addressid,?
  FROM userdata, addressdata 
  RETURNING historyid
)
SELECT userid, addressid, historyid 
FROM userdata, addressdata, historydata;
                            </code></pre>
                        </ul>
                        <aside class="notes">
                            <small><ul>
                                <li>BEFORE set of queries is even slower if coming from an application. Roundtrip on network for each statement.</li>
                                <li>Be careful with multiple update statements. If CTE doesn't depend on another running first, postgres doesn't guarentee order of execution. Can lead to deadlocks.</li>
                            </ul></small>
                        </aside>
                    </section>
                    <section>
                        <h2>Additional 9.1 Features</h2>
                        <ul>
                            <li>Synchronous Replication</li>
                            <li>True serializable transaction isolation</li>
                                <li>Talk on Serialization from Simon Riggs @ 2pm in Room 106</li>
                            <li>Unlogged tables</li>
                        </ul>
                    </section>
                </section> 
                <!-- end of 9.1 -->

                <section data-background="css/theme/omniti_bg_logo.png">
                    <section>
                        <h1>9.2 Features</h1>
                        Released Sept 2012 - EOL Sept 2017<br />
                        Current version 9.2.14
                    </section>
                    <section>
                        <h2>Range Data Type</h2>
                        <ul>
                            <li>Data type representing a range of values of some element type (time, id, custom) </li>
                            <li>Scheduling, probablilty, intersection of ordered data</li>
                        </ul>
                        <pre><code data-trim>
-- includes 3, does not include 7, and does include all points in between
SELECT '[3,7)'::int4range;

-- does not include either 3 or 7, but includes all points in between
SELECT '(3,7)'::int4range;

-- includes only the single point 4
SELECT '[4,4]'::int4range;

-- includes no points (and will be normalized to 'empty')
SELECT '[4,4)'::int4range;


CREATE TABLE reservation (room int, during tsrange);
INSERT INTO reservation VALUES
    (1108, '[2010-01-01 14:30, 2010-01-01 15:30)');


-- Containment
SELECT int4range(10, 20) @> 3;
 ?column? 
----------
 f

-- Overlaps
SELECT numrange(11.1, 22.2) && numrange(20.0, 30.0);
 ?column? 
----------
 t

-- Extract the upper bound
SELECT upper(int8range(15, 25));
 upper 
-------
    25

-- Compute the intersection
SELECT int4range(10, 20) * int4range(15, 25);
 ?column? 
----------
 [15,20)

                        </code></pre>
                    </section>
                    <section>
                        <h2>Range Types</h2>
                        <ul>
                            <li>Practical Example: Buying a car in budget (Thank you <a href="https://twitter.com/jkatz05" target ="_blank">Jonathan Katz</a>)</li>
                            <li>Without range type, table below would have had to have a min_price & max_price column to track its possible range of values</li>
                        </ul>
                        <pre><code data-trim>

test=# SELECT * FROM cars ORDER BY lower(cars.price_range);
 id  | name                | price_range
-----+---------------------+-----------------
 2   | Buick Skylark       | [2000,4001)
 3   | Pontiac GTO         | [5000,7501)
 4   | Chevrolet Camero    | [10000,12001)
 5   | Ford Mustang        | [11000,15001)
 6   | Lincoln Continental | [12000,14001)
 7   | BMW M3              | [35000,42001)
 8   | Audi RS4            | [41000,45001)
 9   | Porsche 911         | [47000,58001)
 10  | Lamborghini LP700   | [385000,400001)

                        </code></pre>
                    </section>
                    <section>
                        <h2>Range Type</h2>
                        <ul>
                            <li>Budget of $13,000 - $15,000</li>
                            <li>Find all cars that have any values in that price range</li>
                            <li>With old min_price / max_price columns, you write fun queries like this:</li>
                        </ul>
                        <pre><code data-trim>
SELECT *
FROM cars
WHERE
    (
        cars.min_price ≤ 13000 AND
        cars.min_price ≤ 15000 AND
        cars.max_price ≥ 13000 AND
        cars.max_price ≤ 15000
    ) OR
    (
        cars.min_price ≤ 13000 AND
        cars.min_price ≤ 15000 AND
        cars.max_price ≥ 13000 AND
        cars.max_price ≥ 15000
    ) OR
    (
        cars.min_price ≥ 13000 AND
        cars.min_price ≤ 15000 AND
        cars.max_price ≥ 13000 AND
        cars.max_price ≤ 15000
    ) OR
    (
        cars.min_price ≥ 13000 AND
        cars.min_price ≤ 15000 AND
        cars.max_price ≥ 13000 AND
        cars.max_price ≥ 15000
    )
ORDER BY cars.min_price;
                        </code></pre>
                    </section>
                    <section>
                        <h2>Range Types</h2>
                        <ul>
                            <li>Range types & operators make this just slightly easier</li>
                        </ul>
                        <pre><code data-trim>
SELECT *
FROM cars
WHERE cars.price_range && int4range(13000, 15000, '[]')
ORDER BY lower(cars.price_range);

 id | name                | price_range
----+---------------------+---------------
 5  | Ford Mustang        | [11000,15001)
 6  | Lincoln Continental | [12000,14001)
                        </code></pre>
                    </section>
                    <!--
                    <section>
                        <h2>Cascading Replication</h2>
                        <ul>
                            <li>Database can be a streaming slave of another slave</li>
                            <li>Every streaming slave off of a master causes additional load for reading its WAL stream</li>
                            <li>Distribute slave load among several systems in large, multi-cluster setups</li>
                        </ul>
                    </section>
                    -->
                    <section>
                        <h2>Additional 9.2 Features</h2>
                        <ul>
                            <li>Index-Only scan</li>
                            <li>JSON Data Type (limited)</li>
                        </ul>
                    </section>
                </section>
                <!-- end of 9.2 -->

                <section data-background="css/theme/omniti_bg_logo.png">
                    <section>
                        <h1>9.3 Features</h1>
                        Released Sept 2013 - EOL Sept 2018<br />
                        Current Version 9.3.10
                    </section>
                    <section>
                        <h2>Reduce System V shared memory</h2>
                        <ol id="li30" style="font-size:30px">
                            <li>Install OS</li>
                            <li>Install PostgreSQL package</li>
                            <li>Do tuning adjustments to fix your shared_buffers (32mb is enough for anyone right?)</li>
                            <li>Restart to put new settings into place</li>
                            <li>Uh oh...</li>
                        </ol>
                        <pre>
IpcMemoryCreate: shmget(key=5432001, size=415776768, 03600) failed: Invalid argument 

This error usually means that PostgreSQL's request for a shared memory 
segment exceeded your kernel's SHMMAX parameter. You can either 
reduce the request size or reconfigure the kernel with larger SHMMAX. 
To reduce the request size (currently 415776768 bytes), reduce 
PostgreSQL's shared_buffers parameter (currently 50000) and/or 
its max_connections parameter (currently 12).
                        </pre>
                        <ul id="li30" style="font-size:30px">
                            <li>No longer an issue with 9.3</li>
                            <li><a href="http://rhaas.blogspot.com/2012/06/absurd-shared-memory-limits.html" target="_blank">Blog post by Robert Haas</a> explains the original cause and fix</li>
                        </ul>
                    </section>
                    <section>
                        <h2>Custom Background Worker</h2>
                        <ul>
                            <li>PostgreSQL already used distinct background processes for its own inner workings (postmaster, writer, logger, autovacuum, stats collector, etc)
                            <li>Now able to program your own workers and let PostgreSQL manage them for you</li>
                            <li>Auto-start & stop along with the database</li>
                            <li>Use custom configuration options in postgresql.conf</li>
                            <li>Example: <a href="https://github.com/keithf4/pg_partman" target="_blank">pg_partman</a> now has a BGW scheduler so separate cronjob is no longer required for partition maintenance</li>
                        </ul>
                    </section>
                    <section>
                        <h2>Additional 9.3 Features</h2>
                        <ul>
                            <li>JSON Operators - Actually useful!</li>
                            <li>LATERAL queries/joins</li>
                            <li>Writable Foreign Data Wrappers</li>
                            <li>An actual PostgreSQL FDW!</li>
                            <li>Parallel pg_dump</li>
                            <li>Materialized Views (kind of useless)</li>
                            <li>Checksum data pages</li>
                        </ul>
                    </section>
                </section>
                <!-- end of 9.3 -->

                <section data-background="css/theme/omniti_bg_logo.png">
                    <section>
                        <h1>9.4 Features</h1>
                        Released Dec 2014 - EOL Dec 2019<br />
                        Current Version 9.4.5
                    </section>
                    <section>
                        <h2>Binary JSON data type</h2>
                        <ul>
                            <li>Even more useful! Possibly replace MongoDB.</li>
                            <ul>
                                <li>Benchmark PG vs Mongo - <a href="https://github.com/EnterpriseDB/pg_nosql_benchmark" target="_blank">https://github.com/EnterpriseDB/pg_nosql_benchmark</a></li>
                            </ul>
                            <li>Same data type validation as before</li>
                            <li>Stored in format that does not require reparsing original text</li>
                            <li>Allows indexing and more efficient storage</li>
                            <li>New operators and functions for better interaction with JSON data</li>
                            <li>Great blogpost with JSONB examples: <a href="http://blog.codeship.com/unleash-the-power-of-storing-json-in-postgres/" target="_blank">Unleash the Power of Storing JSON in Postgres</a></li>
                            <li>JSON Use Cases talk from Christophe Pettus @ 3:3pm in Room 106</li>
                        </ul>
                    </section>
                    <!--
                    <section>
                        <h2>Binary JSON data type</h2>
                        <ul>
                            <li>Great blogpost with JSONB examples: <a href="http://blog.codeship.com/unleash-the-power-of-storing-json-in-postgres/" target="_blank">Unleash the Power of Storing JSON in Postgres</a></li>
                        </ul>
                       <pre><code data-trim>
CREATE TABLE cards (
  id integer NOT NULL,
  board_id integer NOT NULL,
  data jsonb
);
 
INSERT INTO cards VALUES (1, 1, '{"name": "Paint house", "tags": ["Improvements", "Office"], "finished": true}');

SELECT data->>'name' AS name FROM cards;

SELECT count(*) FROM cards WHERE data->>'finished' = 'true';

Aggregate (cost=335.12..335.13 rows=1 width=0) (actual time=4.421..4.421 rows=1 loops=1) -> Seq Scan on cards (cost=0.00..335.00 rows=50 width=0) (actual time=0.016..3.961 rows=4938 loops=1) 
    Filter: ((data ->> 'finished'::text) = 'true'::text) 
    Rows Removed by Filter: 5062 
Planning time: 0.071 ms 
Execution time: 4.465 ms

CREATE INDEX idxfinished ON cards ((data->>'finished'));

Aggregate (cost=118.97..118.98 rows=1 width=0) (actual time=2.122..2.122 rows=1 loops=1) -> Bitmap Heap Scan on cards (cost=4.68..118.84 rows=50 width=0) (actual time=0.711..1.664 rows=4938 loops=1) 
    Recheck Cond: ((data ->> 'finished'::text) = 'true'::text) 
    Heap Blocks: exact=185 
    -> Bitmap Index Scan on idxfinished (cost=0.00..4.66 rows=50 width=0) (actual time=0.671..0.671 rows=4938 loops=1) 
        Index Cond: ((data ->> 'finished'::text) = 'true'::text) 
Planning time: 0.084 ms 
Execution time: 2.199 ms
                        </code> </pre>

                    </section>
                    -->
                    <section>
                        <h2>Replication Slots</h2>
                        <ul>
                            <li>Allows master servers to be aware of slave replication state</li>
                            <li>Master keeps WAL in pg_xlogs for known slaves if they disconnect</li>
                            <li>Previously had to either set wal_keep_segments high or have secondary WAL storage to avoid slave rebuild</li>
                            <li>Ties in with upcoming logical replication features</li>
                        </ul>

                    </section>
                    <section>
                        <h2>Additional 9.4 Features</h2>
                        <ul>
                            <li>ALTER SYSTEM command to dynamically change postgresql.conf within the database</li>
                            <li>Materialzed view refresh no longer blocks reads.</li>
                            <ul>
                                <li>Actually useful! Still not auto-refreshed</li>
                            </ul>
                            <li>Dynamic loading/unloading of Background Workers</li>
                            <li>pg_prewarm</li>
                            <ul>
                                <li>Allows immediate loading of relation data during cluster start into shared_buffers to "warm" them up</li>
                            </ul>
                            <li>Logical decoding in WAL stream. First steps to native logical replication & multi-master.</li>
                            <ul>
                                <li> <a href="http://2ndquadrant.com/en/resources/bdr/" target="_blank">BDR Extension</a> from 2ndQuadrant.</li>
                                <li>BDR Talk from Joshua Drake @ 12:30pm in Room 107</li>
                            </ul>
                            <li>Distinct output of Planning & Execution time from EXPLAIN ANALYZE output</li>
                        </ul>
                    </section>
                </section>
                <!-- end of 9.4 -->

                <section data-background="css/theme/omniti_bg_logo.png">
                    <section>
                        <h1>9.5 Features</h1>
                        Released Jan 2015- EOL Jan 2020<br />
                        Current Version 9.5.0
                    </section>

                    <section>
                        <h2>UPSERT</h2>
                        <ul>
                            <li>INSERT ... ON CONFLICT ...</li>
                            <ul>
                                <li>ON CONSTRAINT ... (better to name columns)</li>
                                <li>DO NOTHING</li>
                                <li>DO UPDATE SET ... [WHERE ...]</li>
                            </ul>
                            <li>"... optimistic variant of regular insertion that first does a pre-check for existing tuples and then attempts an insert."</li>
                            <li>Not quite the same as MERGE in other databases or as defined in SQL standard. This is an actual upsert</li>
                            <li>Use cases talk on UPSERT from Peter Goeghegan @ 10:30am tomorrow in Room 106</li>
                        </section>
                    </section>

                    <section>
                        <h2>Row Level Security</h2>
                        <ul>
                            <li>Control access to data by conditions on the values of that data</li>
                            <li>Adds to already extensive privilege controls (database, schema, table, column)</li>
                            <li>Superusers and object owners bypass RLS. Unless...</li>
                            <li>New GUC - row_security (ON, OFF, FORCE)</li>
                            <li>pg_dump sets row_securty to OFF (--enable-row-security)</li>
                            <li>Multiple policies per table (Results are OR'ed)</li>
                            <li>BYPASSRLS/NOBYPASSRLS - new role property to allow individual roles to bypass RLS</li>
                            <li>Row level security shows up in the \d results</li>
                            <li>Talk on RLS from Joe Conway @ 3:30pm in Room 107</li>
                        </ul>
                    </section>

                    <section>
                        <h2>BRIN Indexes</h2>
                        <ul>
                            <li>Block Range Index / MinMax Index</li>
                            <li>Stores only the bounds-per-heap-page vs BTree method of one index entry for each value</li>
                            <li>Configure how many heap pages contribute to index entry</li>
                            <li>Significantly faster index creation, update &amp; smaller size</li>
                            <li>Sometimes slower index searches than BTree</li>
                            <li>Works better with statically ordered data</li>
                            <li>Really good explanation &amp; examples at <a href="http://pythonsweetness.tumblr.com/post/119568339102/block-range-brin-indexes-in-postgresql-9-5" target="_blank">python sweetness blog</a></li>

                    </section>

                    <section>
                        <h2>Additional 9.5 Features</h2>
                        <ul>
                            <li>Sorting Speed Imporvements (Abbreviated Keys)</li>
                            <li>checkpoint_segments replaced by min_wal_size & max_wal_size</li>
                            <li>Additional GROUP BY options (GROUPING SETS, CUBE, ROLLUP)</li>
                            <li>pg_rewind - no longer have to rebuild failed master scratch</li>
                            <li>JSONB improvements</li>
                            <ul>
                                <li>jsonb_set() - allows in-place editing of JSONB data</li>
                                <li>jsonb_pretty() - more human readable jsonb output</li>
                                <li>Even more functions and operators. See Release Notes</li>
                            </ul>
                            <li>Foreign Table Inheritance - child tables on remote databases</li>
                        </ul>
                    </section>

                </section>
                <!-- end of 9.5 -->
                
                <section data-background="css/theme/omniti_bg_logo.png">
                    <section>
                        <h1>9.6 Features</h1>
                        Current Status - Development (not even alpha)
                    </section>

                    <section>
                        <h2>Upcoming 9.6 Features</h2>
                        <ul>
                            <li>9.6 Performance talk from Mark Wong tomorrow @ 3:30pm in Room 106</li>
                            <li>Parallel Sequential Scan</li>
                            <li>Support multiple -c & -f options for psql</li>
                            <li>%n log_line_prefix value for unix epoch</li>
                            <li>Built in uni-directional logical replication (merge in pglogical extension)</li>
                        </ul>
                    </section>

                </section>
                <!-- end of 9.5 -->
                <section data-background="css/theme/omniti_bg_logo.png">

                    <ul>
                        <li>PostgreSQL Home Page - <a href="http://www.postgresql.org" target="_blank">postgresql.org</a></li>
                        <li>Planet PostgreSQL Community News Feed - <a href="http://planet.postgresql.org" target="_blank">planet.postgresql.org</a></li>
                        <li>PostgreSQL Extension Network - <a href="http://pgxn.org" target="_blank">pgxn.org</a></li>
                        <li>OmniTI - <a href="http://www.omniti.com" target="_blank">omniti.com</a></li>
                        <li>Me! - <a href="http://www.keithf4.com" target="_blank">keithf4.com</a> / <a href="http://twitter.com/keithf4" target="_blank">@keithf4</a></li> 
                        <li>Make cool presentations like this - <a href="https://github.com/hakimel/reveal.js/" target="_blank">reveal.js</a></li>
                    </ul>
                </section>
            </div> 


        </div>
        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.min.js"></script>

        <script>

            // Full list of configuration options available here:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,
                slideNumber: true,

                theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
                transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

                // Parallax scrolling
                // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
                // parallaxBackgroundSize: '2100px 900px',

                // Optional libraries used to extend on reveal.js
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { 
                        hljs.configure({
                                languages: 'sql'
                                })
                        hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                    { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
                ]
            });

        </script>

    </body>
</html>
